name: Go Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [ linux, darwin, windows ]
        goarch: [ amd64, arm64 ]
        exclude:
          - goos: windows
            goarch: arm64

    env:
      CGO_ENABLED: 0

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - run: go test ./...

      - name: Build and package
        run: |
          BUILD_DIR="build-${{ matrix.goos }}-${{ matrix.goarch }}"
          mkdir -p "$BUILD_DIR"
          
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then
            EXT=".exe"
          fi

          for cmd in jwt-claims jwt-sign-hs256 jwt-sign-rs256 jwt-sign-es256 jwe-encrypt-rsa-oaep-a256gcm; do
            go build -o "$BUILD_DIR/${cmd}${EXT}" "./cmd/${cmd}"
          done
          
          mkdir -p dist
          cd "$BUILD_DIR"

          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip -r "../dist/jwt-tools-${{ matrix.goos }}-${{ matrix.goarch }}.zip" .
          else
            tar -czf "../dist/jwt-tools-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz" .
          fi
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}

      - uses: actions/upload-artifact@v4
        with:
          name: jwt-tools-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/jwt-tools-${{ matrix.goos }}-${{ matrix.goarch }}.*

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/jwt-tools-*
